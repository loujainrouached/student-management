pipeline {
    agent any

    tools {
        maven 'MAVEN'
    }

    environment {
        DOCKER_IMAGE = 'loujainrouached/student-app'
        DOCKER_TAG   = "${BUILD_NUMBER}"
        NAMESPACE    = 'devops'
    }

    stages {

        /* =======================
           CHECKOUT CODE
        ======================= */
        stage('Checkout') {
            steps {
                echo 'üì• Cloning repository...'
                git branch: 'main',
                    url: 'https://github.com/loujainrouached/student-management.git'
            }
        }

        /* =======================
           MAVEN BUILD
        ======================= */
        stage('Build with Maven') {
            steps {
                echo 'üî® Maven build...'
                dir('student-management') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        /* =======================
           SONARQUBE
        ======================= */
        stage('SonarQube Analysis') {
            steps {
                echo 'üîç SonarQube analysis...'
                dir('student-management') {
                    withSonarQubeEnv('Sonarqube') {
                        sh 'mvn sonar:sonar || true'
                    }
                }
            }
        }

        /* =======================
           DOCKER BUILD (MINIKUBE)
        ======================= */
        stage('Build Docker Image (Minikube)') {
            steps {
                echo 'üê≥ Building Docker image in Minikube...'
                dir('student-management') {
                    sh """
                        minikube image build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                    """
                }
            }
        }

        /* =======================
           KUBERNETES DEPLOY
        ======================= */
        stage('KUBERNETES DEPLOY') {
            steps {
                echo '‚ò∏Ô∏è Deploying to Kubernetes...'
                sh '''
                    kubectl apply -f k8s/
                    kubectl rollout status deployment/student-management -n devops --timeout=5m
                    kubectl get pods -n devops
                    kubectl get svc -n devops
                '''
            }
        }

        /* =======================
           API REST TEST
        ======================= */
        stage('CREATE DEPARTMENT (API REST)') {
            steps {
                echo 'üåê Calling REST API...'
                sh '''
                    sleep 20
                    curl -X POST http://192.168.49.2:32639/department/createDepartment \
                    -H "Content-Type: application/json" \
                    -d '{"name":"Finance","location":"Sfax"}'
                '''
            }
        }
    }

    post {
        success {
            echo '‚úÖ PIPELINE TERMIN√â AVEC SUCC√àS'
        }
        failure {
            echo '‚ùå PIPELINE √âCHOU√â'
        }
    }
}
