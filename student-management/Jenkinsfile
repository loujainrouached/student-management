pipeline {
    agent any

    tools {
        maven 'MAVEN'
    }

    environment {
        DOCKER_IMAGE = 'loujainrouached/student-app'
        DOCKER_TAG   = "${BUILD_NUMBER}"
        NAMESPACE    = 'devops'
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'üì• Cloning repository...'
                git branch: 'main',
                    url: 'https://github.com/loujainrouached/student-management.git'
            }
        }

        stage('Build with Maven') {
            steps {
                echo 'üî® Maven build...'
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                echo 'üîç SonarQube analysis...'
                withSonarQubeEnv('Sonarqube') {
                    sh 'mvn sonar:sonar || true'
                }
            }
        }

        stage('Build Docker Image (Minikube)') {
            steps {
                echo 'üê≥ Building Docker image inside Minikube...'
                sh """
                    minikube profile minikube
                    minikube image build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                """
            }
        }

        stage('KUBERNETES DEPLOY') {
            steps {
                echo '‚ò∏Ô∏è Kubernetes Deployment...'
                sh """
                    kubectl get nodes
                    kubectl apply -f k8s/
                    kubectl get pods -n ${NAMESPACE}
                    kubectl get svc -n ${NAMESPACE}
                """
            }
        }

        stage('CREATE DEPARTMENT (API REST)') {
            steps {
                echo 'üì° Creating department via API...'
                sh '''
                    sleep 20
                    curl -X POST http://192.168.49.2:32639/department/createDepartment \
                         -H "Content-Type: application/json" \
                         -d '{"name":"Finance","location":"Sfax"}'
                '''
            }
        }
    }

    post {
        success {
            echo '‚úÖ PIPELINE TERMIN√â AVEC SUCC√àS üéâ'
        }
        failure {
            echo '‚ùå PIPELINE √âCHOU√â'
        }
    }
}
